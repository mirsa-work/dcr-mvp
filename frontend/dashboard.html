<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCR Dashboard</title>

    <!-- ─── External Dependencies ────────────────────────── -->
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet">

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

    <!-- ─── Application Styles ───────────────────────────── -->
    <style>
        /* Status badges */
        .badge-DRAFT {
            background: #6c757d;
        }

        .badge-REJECTED {
            background: #dc3545;
        }

        .badge-SUBMITTED {
            background: #0d6efd;
        }

        .badge-ACCEPTED {
            background: #198754;
        }

        /* Status icons (for mobile) */
        .status-icon {
            display: none;
            /* Hidden by default (shown on mobile) */
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: relative;
        }

        .status-icon::after {
            font-family: "bootstrap-icons";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            color: white;
        }

        /* Mobile-only display */
        @media (max-width: 767.98px) {
            .status-icon {
                display: inline-block;
            }

            /* Icon definitions */
            .status-icon[data-status="DRAFT"] {
                background-color: #6c757d;
            }

            .status-icon[data-status="DRAFT"]::after {
                content: "\F287";
                /* bi-pencil */
            }

            .status-icon[data-status="SUBMITTED"] {
                background-color: #0d6efd;
            }

            .status-icon[data-status="SUBMITTED"]::after {
                content: "\F138";
                /* bi-send */
            }

            .status-icon[data-status="ACCEPTED"] {
                background-color: #198754;
            }

            .status-icon[data-status="ACCEPTED"]::after {
                content: "\F26C";
                /* bi-check-circle */
            }

            .status-icon[data-status="REJECTED"] {
                background-color: #dc3545;
            }

            .status-icon[data-status="REJECTED"]::after {
                content: "\F62A";
                /* bi-x-circle */
            }
        }

        .action-btn {
            margin-right: 0.4rem;
            font-size: 1rem;
            cursor: pointer;
        }

        .action-btn:last-child {
            margin-right: 0;
        }

        /* Sidebar transition for mobile */
        @media (max-width: 767.98px) {
            #sideBar {
                position: fixed;
                left: -100%;
                top: 0;
                width: 220px;
                height: 100vh;
                transition: left 0.2s;
                z-index: 1040;
            }

            #sideBar.open {
                left: 0;
            }
        }

        #dcrTable td:nth-child(2) {
            white-space: normal !important;
            word-break: break-word;
            max-width: 100px;
        }

        .readonly-input {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .dcr-number-link {
            color: inherit;
            text-decoration: none;
        }

        .dcr-number-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body class="d-flex flex-column h-100">
    <!-- Login View -->
    <div id="loginView"
        class="position-fixed top-0 start-0 vw-100 vh-100 d-flex justify-content-center align-items-center bg-white bg-opacity-90 z-3 d-none">
        <div class="card p-3 p-md-4" style="max-width: 400px; width: 90%;">
            <div class="card-body">
                <div class="text-center mb-4">
                    <span class="bi bi-stack fs-3 me-2"></span>
                    <h4 class="d-inline-block">Southern Slice</h4>
                </div>
                <h5 class="mb-4 text-center">Login</h5>
                <form id="loginForm">
                    <div class="mb-3">
                        <input id="username" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="mb-3">
                        <input id="password" type="password" class="form-control" placeholder="Password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                    <div id="loginError" class="text-danger mt-2 text-center"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Application Shell -->
    <div id="appShell" class="d-flex flex-column flex-grow-1 d-none">
        <!-- Sidebar and Main Content Container -->
        <div class="row g-0 flex-grow-1">
            <!-- Sidebar Navigation - col on desktop, off-canvas on mobile -->
            <nav id="sideBar" class="col-md-2 bg-light border-end p-3">
                <div class="text-center mb-4">
                    <span class="bi bi-stack fs-3 me-2"></span>
                    <h5 class="d-inline-block">Southern Slice</h5>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="bi bi-file-earton-text me-2"></i>Daily Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#">
                            <i class="bi bi-folder me-2"></i>Future Reports
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Main Content Area -->
            <div class="col-md-10 d-flex flex-column">
                <!-- Header -->
                <header class="sticky-top bg-white border-bottom p-2 p-md-3">
                    <div class="row align-items-center g-0">
                        <div class="col-auto me-2">
                            <button id="toggleSidebar" class="btn btn-sm btn-outline-secondary d-lg-none py-1">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                        <div class="col">
                            <h5 class="m-0">
                                <i class="bi bi-clipboard-data me-2"></i>Daily Consumption Reports
                            </h5>
                        </div>
                        <div class="col-auto">
                            <div class="dropdown">
                                <button id="userMenu"
                                    class="btn btn-outline-secondary btn-sm dropdown-toggle text-nowrap py-1"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-person-circle me-1"></i>
                                    <span id="usernameDisplay" class="text-truncate d-none d-md-inline"
                                        style="max-width: 120px;"></span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" id="logoutBtn" href="#">
                                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                                        </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Main Content -->
                <main class="flex-grow-1 p-3 overflow-auto">
                    <!-- Dashboard View -->
                    <div id="dashboardView" class="h-100 d-flex flex-column">
                        <!-- Controls Row -->
                        <div class="row g-2 g-md-3 mb-3">
                            <div class="col-12 col-md-5 col-lg-4">
                                <select id="branchSelect" class="form-select"></select>
                            </div>
                            <div class="col-8 col-md-3 col-lg-3">
                                <input id="monthSelect" type="month" class="form-control">
                            </div>
                            <div class="col-4 col-md-2 col-lg-3 d-flex gap-2">
                                <button id="refreshBtn" class="btn btn-outline-secondary flex-grow-1 text-nowrap">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    <span class="d-none d-md-inline"> Refresh</span>
                                </button>
                                <button id="newDcrBtn" class="btn btn-success flex-grow-1 text-nowrap">
                                    <i class="bi bi-plus-circle"></i>
                                    <span class="d-none d-md-inline"> New</span>
                                </button>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="table-responsive">
                            <table class="table table-sm table-hover" id="dcrTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>DCR #</th>
                                        <th>Status</th>
                                        <th style="width:100px">Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal fade" id="dcrModal" tabindex="-1" aria-labelledby="dcrModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dcrModalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="dcrForm" class="row g-3"></form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="saveDcrBtn" class="btn btn-primary">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    </div>

    <!-- ─── Application Script ───────────────────────────── -->
    <script>
        /**
         * DCR Dashboard Application
         * 
         * This application manages Daily Consumption Reports with features for:
         * - User authentication
         * - Branch selection
         * - DCR creation, editing, and submission
         * - Status management (Draft, Submitted, Accepted, Rejected)
         */
        (function (window, $) {
            'use strict';

            // Application namespace
            const DCR = {
                // Configuration
                config: {
                    apiBaseUrl: '', // To be set during initialization
                    endpoints: {
                        login: '/api/login',
                        branches: '/api/branches',
                        dcr: '/api/dcr',
                        formSpec: '/api/form-spec'
                    },
                    localStorageKeys: {
                        token: 'jwt',
                        user: 'user'
                    }
                },

                // State management
                state: {
                    token: null,
                    user: null,
                    branches: [],
                    formSpecs: {}, // Cached by branch code
                    editId: null,
                    dataTable: null
                },

                // DOM elements cache
                elements: {
                    // Views
                    loginView: null,
                    appShell: null,

                    // Login form
                    loginForm: null,
                    usernameInput: null,
                    passwordInput: null,
                    loginError: null,

                    // App shell
                    toggleSidebarBtn: null,
                    usernameDisplay: null,
                    logoutBtn: null,

                    // Dashboard
                    branchSelect: null,
                    monthSelect: null,
                    refreshBtn: null,
                    newDcrBtn: null,
                    dcrTable: null,

                    // DCR Modal
                    dcrModal: null,
                    dcrModalTitle: null,
                    dcrForm: null,
                    saveDcrBtn: null,

                    // Toast container
                    toastContainer: null
                },

                // Initialize the application
                init: function () {
                    this.cacheElements();
                    this.bindEvents();
                    this.initializeUI();
                },

                // Cache DOM elements for better performance
                cacheElements: function () {
                    const el = this.elements;

                    // Views
                    el.loginView = $('#loginView');
                    el.appShell = $('#appShell');

                    // Login form
                    el.loginForm = $('#loginForm');
                    el.usernameInput = $('#username');
                    el.passwordInput = $('#password');
                    el.loginError = $('#loginError');

                    // App shell
                    el.toggleSidebarBtn = $('#toggleSidebar');
                    el.usernameDisplay = $('#usernameDisplay');
                    el.logoutBtn = $('#logoutBtn');

                    // Dashboard
                    el.branchSelect = $('#branchSelect');
                    el.monthSelect = $('#monthSelect');
                    el.refreshBtn = $('#refreshBtn');
                    el.newDcrBtn = $('#newDcrBtn');
                    el.dcrTable = $('#dcrTable');

                    // DCR Modal
                    el.dcrModal = new bootstrap.Modal('#dcrModal');
                    el.dcrModalTitle = $('#dcrModalTitle');
                    el.dcrForm = $('#dcrForm');
                    el.saveDcrBtn = $('#saveDcrBtn');

                    // Toast container
                    el.toastContainer = $('#toastContainer');
                },

                // Bind event handlers
                bindEvents: function () {
                    const el = this.elements;

                    // Login form
                    el.loginForm.on('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });

                    // App shell
                    el.toggleSidebarBtn.on('click', () => {
                        $('#sideBar').toggleClass('open');
                    });

                    el.logoutBtn.on('click', (e) => {
                        e.preventDefault();
                        this.handleLogout();
                    });

                    // Dashboard
                    el.branchSelect.on('change', () => this.handleBranchChange());
                    el.monthSelect.on('change', () => this.loadDcrTable());
                    el.refreshBtn.on('click', () => this.loadDcrTable());
                    el.newDcrBtn.on('click', () => this.openDcrModal(null));

                    // DCR link clickable
                    el.dcrTable.on('click', '.dcr-number-link', (e) => {
                        e.preventDefault();
                        const dcrId = $(e.target).closest('tr').data('id');
                        const dcrStatus = $(e.target).closest('tr').data('status');
                        this.openDcrModal(dcrId, dcrStatus);
                    });

                    // DCR Table actions
                    el.dcrTable.on('click', '.action-btn', (e) => {
                        const action = $(e.target).data('action');
                        const dcrId = $(e.target).closest('tr').data('id');
                        this.handleDcrAction(action, dcrId);
                    });

                    // DCR Modal
                    el.saveDcrBtn.on('click', () => this.saveDcr());
                },

                // Initialize UI state
                initializeUI: function () {
                    // Check for existing session
                    const token = localStorage.getItem(this.config.localStorageKeys.token);

                    if (token) {
                        this.state.token = token;
                        this.loadUserFromStorage();
                        this.showAppShell();
                        this.bootstrapApplication();
                    } else {
                        this.showLoginView();
                    }
                },

                // Show login view
                showLoginView: function () {
                    this.elements.loginView.removeClass('d-none');
                    this.elements.appShell.addClass('d-none');
                },

                // Show application shell
                showAppShell: function () {
                    this.elements.loginView.addClass('d-none');
                    this.elements.appShell.removeClass('d-none');
                },

                // ─── Authentication ───────────────────────
                handleLogin: function () {
                    const username = this.elements.usernameInput.val().trim();
                    const password = this.elements.passwordInput.val();

                    if (!username || !password) {
                        this.showLoginError('Please enter both username and password');
                        return;
                    }

                    this.apiRequest({
                        url: this.config.endpoints.login,
                        method: 'POST',
                        data: { username, password },
                        skipAuth: true
                    })
                        .then(response => {
                            this.state.token = response.token;
                            this.state.user = response.user;

                            // Store credentials
                            localStorage.setItem(this.config.localStorageKeys.token, response.token);
                            localStorage.setItem(this.config.localStorageKeys.user, JSON.stringify(response.user));

                            // Update UI and bootstrap application
                            this.showAppShell();
                            this.bootstrapApplication();
                        })
                        .catch(error => {
                            this.showLoginError(error.message || 'Login failed');
                        });
                },

                handleLogout: function () {
                    // Clear state and storage
                    this.state.token = null;
                    this.state.user = null;
                    localStorage.removeItem(this.config.localStorageKeys.token);
                    localStorage.removeItem(this.config.localStorageKeys.user);

                    // Reload the page to reset the application
                    window.location.reload();
                },

                loadUserFromStorage: function () {
                    const userData = localStorage.getItem(this.config.localStorageKeys.user);
                    if (userData) {
                        try {
                            this.state.user = JSON.parse(userData);
                        } catch (e) {
                            console.error('Failed to parse user data from storage', e);
                            DCR.handleLogout();
                        }
                    }
                },

                showLoginError: function (message) {
                    this.elements.loginError.text(message).fadeIn();
                    setTimeout(() => this.elements.loginError.fadeOut(), 3000);
                },

                // ─── Application Bootstrap ────────────────
                bootstrapApplication: function () {
                    // Update UI with user info
                    this.elements.usernameDisplay.text(this.state.user.username);

                    // Hide new DCR button if user doesn't have permission
                    if (this.state.user.role !== 'BRANCH') {
                        this.elements.newDcrBtn.hide();
                    }

                    // Load branches and initialize the dashboard
                    this.loadBranches()
                        .then(() => {
                            // Set current month to today
                            const today = new Date();
                            const currentMonth = today.toISOString().slice(0, 7);
                            this.elements.monthSelect.val(currentMonth);

                            // Load initial data
                            this.loadDcrTable();
                        })
                        .catch(error => {
                            this.showToast('Failed to load branches', 'danger');
                            console.error('Bootstrap error:', error);
                        });
                },

                // ─── Data Loading ────────────────────────
                loadBranches: function () {
                    return this.apiRequest({
                        url: this.config.endpoints.branches
                    })
                        .then(branches => {
                            this.state.branches = branches;
                            this.populateBranchSelect(branches);

                            // Set the first branch as current
                            if (branches.length > 0) {
                                return this.ensureFormSpec(branches[0].id, branches[0].code);
                            }
                        });
                },

                populateBranchSelect: function (branches) {
                    const select = this.elements.branchSelect.empty();

                    branches.forEach(branch => {
                        select.append(
                            `<option value="${branch.id}" data-code="${branch.code}">${branch.name}</option>`
                        );
                    });
                },

                ensureFormSpec: function (branchId, branchCode) {
                    // Return if already cached
                    if (this.state.formSpecs[branchCode]) {
                        return Promise.resolve();
                    }

                    return this.apiRequest({
                        url: `${this.config.endpoints.formSpec}?branchId=${branchId}`
                    })
                        .then(spec => {
                            this.state.formSpecs[branchCode] = spec;
                        });
                },

                loadDcrTable: function () {
                    const branchId = this.elements.branchSelect.val();
                    const month = this.elements.monthSelect.val();

                    this.apiRequest({
                        url: `/api/branches/${branchId}/dcr?month=${month}`
                    })
                        .then(data => {
                            this.renderDcrTable(data);
                        })
                        .catch(error => {
                            this.showToast('Failed to load DCR data', 'danger');
                            console.error('DCR table load error:', error);
                        });
                },

                renderDcrTable: function (rows) {
                    // Destroy existing DataTable if it exists
                    if (this.state.dataTable) {
                        this.state.dataTable.destroy();
                        this.state.dataTable = null;
                    }
                    const tableBody = this.elements.dcrTable.find('tbody').empty();

                    // Add rows to table
                    rows.forEach(row => {
                        tableBody.append(this.createDcrTableRow(row));
                    });

                    // Initialize DataTable
                    this.state.dataTable = new DataTable('#dcrTable', {
                        pageLength: 10,
                        order: [[0, 'desc']],
                        responsive: true
                    });
                },

                createDcrTableRow: function (dcr) {
                    return `
                        <tr data-id="${dcr.id}" data-status="${dcr.status}">
                            <td>${this.formatDate(dcr.dcr_date)}</td>
                            <td><a href="#" class="dcr-number-link">${dcr.dcr_number}</a></td>
                            <td>
                                <span class="d-none d-md-inline badge badge-${dcr.status}">${dcr.status}</span>
                                <span class="d-md-none status-icon" data-status="${dcr.status}" title="${dcr.status}"></span>
                            </td>
                            <td>${this.createActionButtons(dcr)}</td>
                        </tr>
                    `;
                },

                createActionButtons: function (dcr) {
                    const actions = [];
                    const isBranchUser = this.state.user.role === 'BRANCH';
                    const isAdminUser = this.state.user.role === 'ADMIN';

                    if (['DRAFT', 'REJECTED'].includes(dcr.status) && isBranchUser) {
                        actions.push(this.createActionButton('pencil', 'edit', 'Edit'));
                        actions.push(this.createActionButton('arrow-up-circle', 'submit', 'Submit'));
                    }

                    if (dcr.status === 'SUBMITTED' && isAdminUser) {
                        actions.push(this.createActionButton('check-circle', 'accept', 'Accept'));
                        actions.push(this.createActionButton('x-circle', 'reject', 'Reject'));
                    }

                    if (dcr.status === 'ACCEPTED' && isAdminUser) {
                        actions.push(this.createActionButton('arrow-counterclockwise', 'reopen', 'Re-open'));
                    }

                    return actions.length > 0 ? actions.join('') : '—';
                },

                createActionButton: function (icon, action, title) {
                    return `<i class="bi bi-${icon} action-btn" data-action="${action}" title="${title}"></i>`;
                },

                // ─── DCR Actions ─────────────────────────
                handleDcrAction: function (action, dcrId) {
                    const actions = {
                        edit: () => this.openDcrModal(dcrId, 'DRAFT'),
                        submit: () => this.updateDcrStatus(dcrId, 'submit'),
                        accept: () => this.updateDcrStatus(dcrId, 'accept'),
                        reject: () => {
                            const reason = prompt('Reject reason?');
                            if (reason !== null) {
                                this.updateDcrStatus(dcrId, 'reject', { reason });
                            }
                        },
                        reopen: () => this.updateDcrStatus(dcrId, 'reopen')
                    };

                    if (actions[action]) {
                        actions[action]();
                    }
                },

                updateDcrStatus: function (dcrId, action, data = {}) {
                    this.apiRequest({
                        url: `/api/dcr/${dcrId}/${action}`,
                        method: 'POST',
                        data: data
                    })
                        .then(() => {
                            this.showToast(`DCR ${action} successful`);
                            this.loadDcrTable();
                        })
                        .catch(error => {
                            this.showToast(`Failed to ${action} DCR`, 'danger');
                            console.error(`DCR ${action} error:`, error);
                        });
                },

                // ─── DCR Modal ──────────────────────────
                openDcrModal: function (dcrId, dcrStatus) {
                    const isReadOnly = this.state.user.role !== 'BRANCH' || (dcrId && dcrStatus !== 'DRAFT' && dcrStatus !== 'REJECTED');

                    this.state.editId = dcrId;
                    const branchCode = this.elements.branchSelect.find('option:selected').data('code');
                    const formSpec = this.state.formSpecs[branchCode];

                    if (!formSpec) {
                        this.showToast('No form specification available for this branch', 'danger');
                        return;
                    }

                    // Set modal title
                    this.elements.dcrModalTitle.text(dcrId ? (isReadOnly ? 'View DCR' : 'Edit DCR') : 'New Daily Consumption Report');

                    // Build form
                    this.buildDcrForm(formSpec, isReadOnly);

                    // Load data if editing
                    if (dcrId) {
                        this.loadDcrData(dcrId);
                    }

                    // Show modal
                    this.elements.dcrModal.show();
                },

                buildDcrForm: function (formSpec, isReadOnly = false) {
                    const form = this.elements.dcrForm.empty();
                    const groups = formSpec.groups || [{
                        label: '',
                        fields: Array.isArray(formSpec) ? formSpec : formSpec.fields || []
                    }];

                    groups.forEach(group => {
                        if (group.label) {
                            form.append(`
                                <div class="col-12 form-section">
                                    <h6 class="form-section-header">${group.label}</h6>
                                    <hr class="mt-0 mb-2">
                                </div>
                            `);
                        }

                        group.fields.forEach(field => {
                            const inputType = field.type === 'date' ? 'date' : 'number';
                            const step = field.type === 'decimal' ? '0.01' : '1';

                            form.append(`
                                <div class="col-md-4">
                                    <label class="form-label">
                                        ${field.label}${field.required ? '<span class="text-danger">*</span>' : ''}
                                    </label>
                                    <input class="form-control ${isReadOnly ? 'readonly-input' : ''}" 
                                           type="${inputType}" 
                                           step="${step}" 
                                           name="${field.key}" 
                                           ${isReadOnly ? 'readonly' : ''} 
                                           ${field.required ? 'required' : ''}>
                                </div>
                            `);
                        });
                    });

                    // Hide save button if in read-only mode
                    if (isReadOnly) {
                        this.elements.saveDcrBtn.hide();
                    } else {
                        this.elements.saveDcrBtn.show();
                    }
                },

                loadDcrData: function (dcrId) {
                    this.apiRequest({
                        url: `${this.config.endpoints.dcr}/${dcrId}`
                    })
                        .then(dcr => {
                            this.populateDcrForm(dcr);
                        })
                        .catch(error => {
                            this.showToast('Failed to load DCR data', 'danger');
                            console.error('DCR load error:', error);
                        });
                },

                populateDcrForm: function (dcr) {
                    Object.entries(dcr).forEach(([key, value]) => {
                        const input = this.elements.dcrForm.find(`[name="${key}"]`);

                        if (input.length) {
                            input.val(key === 'date' ? value.slice(0, 10) : value);
                        }
                    });
                },

                saveDcr: function () {
                    // Validate form
                    if (!this.elements.dcrForm[0].reportValidity()) {
                        return;
                    }

                    const formData = this.serializeForm(this.elements.dcrForm);
                    const branchId = this.elements.branchSelect.val();

                    const request = this.state.editId
                        ? {
                            url: `${this.config.endpoints.dcr}/${this.state.editId}`,
                            method: 'PUT'
                        }
                        : {
                            url: `/api/branches/${branchId}/dcr`,
                            method: 'POST'
                        };

                    this.apiRequest({
                        ...request,
                        data: formData
                    })
                        .then(() => {
                            this.elements.dcrModal.hide();
                            this.showToast('DCR saved successfully');
                            this.loadDcrTable();
                        })
                        .catch(error => {
                            let errorMessage = 'Failed to save DCR';
                            if (error.message) {
                                errorMessage = error.message;
                            }
                            this.showToast(errorMessage, 'danger');
                            console.error('DCR save error:', error);
                        });
                },

                serializeForm: function (form) {
                    return Object.fromEntries(
                        form.serializeArray().map(item => [item.name, item.value])
                    );
                },

                // ─── API Utilities ──────────────────────
                apiRequest: function (options) {
                    const defaults = {
                        url: '',
                        method: 'GET',
                        data: null,
                        skipAuth: false
                    };

                    const config = { ...defaults, ...options };

                    return new Promise((resolve, reject) => {
                        $.ajax({
                            url: `${this.config.apiBaseUrl}${config.url}`,
                            method: config.method,
                            contentType: 'application/json',
                            data: config.data ? JSON.stringify(config.data) : undefined,
                            headers: config.skipAuth ? {} : {
                                Authorization: `Bearer ${this.state.token}`
                            }
                        })
                            .done(response => resolve(response))
                            .fail(xhr => {
                                const error = this.parseApiError(xhr);
                                reject(error);
                            });
                    });
                },

                parseApiError: function (xhr) {
                    try {
                        const response = xhr.responseJSON;

                        if (response && response.error) {
                            return new Error(response.error);
                        }

                        if (response && response.errors) {
                            return new Error(response.errors.join(', '));
                        }
                    } catch (e) {
                        console.error('Error parsing API error:', e);
                    }

                    return new Error(xhr.statusText || 'Request failed');
                },

                // ─── UI Utilities ────────────────────────
                showToast: function (message, type = 'success') {
                    const toastId = `toast-${Date.now()}`;
                    const toastClass = type === 'success' ? 'bg-success' : 'bg-danger';

                    const toast = $(`
                        <div id="${toastId}" class="toast ${toastClass} text-white">
                            <div class="toast-body">${message}</div>
                        </div>
                    `);

                    this.elements.toastContainer.append(toast);

                    // Show and auto-remove toast
                    const bsToast = new bootstrap.Toast(toast[0], { delay: 3000 });
                    bsToast.show();

                    toast.on('hidden.bs.toast', () => {
                        toast.remove();
                    });
                },

                formatDate: function (isoDate) {
                    const date = new Date(isoDate);
                    return date.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                },

                // ─── Event Handlers ──────────────────────
                handleBranchChange: function () {
                    const branchId = this.elements.branchSelect.val();
                    const branchCode = this.elements.branchSelect.find('option:selected').data('code');

                    this.ensureFormSpec(branchId, branchCode)
                        .then(() => this.loadDcrTable())
                        .catch(error => {
                            this.showToast('Failed to load branch specification', 'danger');
                            console.error('Branch change error:', error);
                        });
                }
            };

            // Initialize the application when DOM is ready
            $(document).ready(() => {
                DCR.init();
            });

            // Expose for debugging if needed
            window.DCR = DCR;
        })(window, jQuery);
    </script>
</body>

</html>