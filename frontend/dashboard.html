<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>DCR Dashboard (stub)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body class="p-3">
    <div id="loginBox">
        <h3>Login</h3>
        <input id="user" placeholder="username"><br>
        <input id="pass" placeholder="password" type="password"><br>
        <button id="loginBtn" class="btn btn-primary">Login</button>
        <div id="err" class="text-danger mt-2"></div>
    </div>

    <div id="mainBox" style="display:none;">
        <h3>DCRs (branch 1)</h3>
        <button id="refresh" class="btn btn-secondary btn-sm">Refresh</button>
        <button id="newBtn" class="btn btn-success btn-sm">New (quick)</button>
        <table class="table mt-2" id="tbl">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>DCR #</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let token = '', role = '', branchId = 1;

        $('#loginBtn').on('click', () => {
            $.post('/api/login', { username: $('#user').val(), password: $('#pass').val() })
                .done(r => {
                    token = r.token;
                    role = r.user.role;
                    branchId = r.user.branch_id || 1;
                    $('#loginBox').hide(); $('#mainBox').show();
                    load();
                })
                .fail(x => $('#err').text(x.responseJSON?.error || 'fail'));
        });

        function authHeaders() { return { Authorization: `Bearer ${token}` } }

        function load() {
            $.ajax({ url: `/api/branches/${branchId}/dcr`, headers: authHeaders() })
                .done(rows => {
                    const body = rows.map(r => {
                        const btns = actionButtons(r);
                        const rr = r.reject_reason ? `<br><small class="text-danger">${r.reject_reason}</small>` : '';
                        return `<tr>
                  <td>${r.dcr_date}</td>
                  <td>${r.dcr_number}</td>
                  <td>${r.status}${rr}</td>
                  <td>${btns}</td>
                </tr>`;
                    }).join('');
                    $('#tbl tbody').html(body);
                });
        }

        function actionButtons(r) {
            if (role === 'BRANCH') {
                if (['DRAFT', 'REJECTED'].includes(r.status))
                    return `<button data-id="${r.id}" class="btn btn-sm btn-warning submit">Submit</button>`;
                return '';
            }
            if (role === 'ADMIN') {
                if (r.status === 'SUBMITTED')
                    return `<button data-id="${r.id}" class="btn btn-sm btn-success accept">Accept</button>
                      <button data-id="${r.id}" class="btn btn-sm btn-danger reject">Reject</button>`;
                if (r.status === 'ACCEPTED')
                    return `<button data-id="${r.id}" class="btn btn-sm btn-secondary reopen">Reâ€‘open</button>`;
            }
            return '';
        }

        $('#tbl').on('click', '.submit', e => wf('submit', e));
        $('#tbl').on('click', '.accept', e => wf('accept', e));
        $('#tbl').on('click', '.reject', e => {
            const reason = prompt('Reject reason?');
            if (reason) wf('reject', e, { reason });
        });
        $('#tbl').on('click', '.reopen', e => wf('reopen', e));

        function wf(action, e, data = {}) {
            const id = $(e.target).data('id');
            $.ajax({
                method: 'POST',
                url: `/api/dcr/${id}/${action}`,
                headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                data: JSON.stringify(data)
            })
                .done(() => load())
                .fail(x => alert(JSON.stringify(x.responseJSON)));
        }

        $('#refresh').on('click', load);
        $('#newBtn').on('click', () => alert('Form builder coming Dayâ€‘5 ðŸ˜‰'));
    </script>
</body>

</html>